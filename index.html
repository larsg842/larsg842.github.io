<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Meine persönliche Startseite</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <style>
        :root {
            --bg: #fafaf0; /* Helleres Creme */
            --fg: #222;
            --accent: #002147; /* Dunkles Blau */
            --card-bg: #fffaf0; /* Creme Variation */
            --map-iframe-src: 'map_1_basiskarte.html';
            --border: #ccc;
            --muted: #555;
        }
        /* Dark theme variables */
        body.dark {
            --bg: #1a1a2e; /* Dunkles Blau Variation */
            --fg: #e6eef6;
            --accent: #3aa0ff;
            --card-bg: #16213e; /* Dunkleres Blau */
            --border: #1f2a37;
            --muted: #9fb7d9;
        }

        html { box-sizing: border-box; }
        *, *::before, *::after { box-sizing: inherit; }

        body {
            margin: 0;
            padding: 0;
            background: var(--bg);
            color: var(--fg);
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            line-height: 1.6;
            min-height: 100vh;
        }

        .osm-map {
            width: 100%;
            height: 250px;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: linear-gradient(180deg, rgba(0,0,0,0.02), transparent);
        }

        header {
            background: var(--accent);
            color: #fff;
            padding: 1.5rem 1rem 1rem 1rem;
            text-align: center;
            position: relative;
        }
        header h1 { margin: 0 0 0.25rem 0; font-size: 2.2rem; letter-spacing: 0.02em; }
        header p { margin: 0; opacity: 0.95; }

        /* Theme toggle */
        .theme-toggle {
            position: absolute;
            right: 1rem;
            top: 1rem;
            background: rgba(255,255,255,0.12);
            border: 1px solid rgba(255,255,255,0.12);
            color: white;
            padding: 0.35rem 0.6rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        body.dark .theme-toggle {
            background: rgba(0,0,0,0.24);
            border-color: rgba(255,255,255,0.06);
            color: var(--fg);
        }

        main {
            max-width: 1000px;
            margin: 1.5rem auto;
            padding: 0 1rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }
        .tabs button {
            background: var(--card-bg);
            color: var(--fg);
            border: 1px solid var(--border);
            padding: 0.5rem 0.9rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .tabs button[aria-pressed="true"], .tabs button:focus {
            background: linear-gradient(180deg, rgba(0,0,0,0.04), transparent);
            border-color: var(--accent);
            color: var(--accent);
            outline: none;
            box-shadow: 0 4px 12px rgba(0,87,184,0.06);
        }
        body.dark .tabs button {
            background: transparent;
            border-color: var(--border);
            color: var(--muted);
        }
        body.dark .tabs button[aria-pressed="true"] {
            color: var(--accent);
            background: rgba(58,160,255,0.06);
        }

        section { width: 100%; }

        .intro {
            display: flex;
            flex-wrap: wrap;
            gap: 1.25rem;
            align-items: center;
        }
        .intro figure { margin: 0; flex: 0 0 140px; }
        .intro img {
            width: 140px; height: 140px; object-fit: cover;
            border-radius: 50%; border: 3px solid var(--accent);
            background: #eee; display: block;
        }
        .intro-text { flex: 1 1 200px; min-width: 200px; }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            margin-top: 1rem;
        }
        th, td {
            padding: 0.7em 1em;
            text-align: left;
            border-bottom: 1px solid var(--border);
            color: var(--fg);
        }
        th {
            background: var(--accent);
            color: #fff;
            font-weight: 600;
        }
        tr:last-child td { border-bottom: none; }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: box-shadow 0.2s;
            border: 1px solid var(--border);
            text-decoration: none;
            color: inherit;
        }
        .card:hover, .card:focus {
            box-shadow: 0 4px 16px rgba(0,87,184,0.10);
            border-color: var(--accent);
            outline: none;
        }

        .card img { width: 100%; height: 120px; object-fit: cover; background: #ddd; display: block; }
        .card-content { padding: 1em; flex: 1; display: flex; flex-direction: column; gap: 0.5em; }
        .card-title { font-size: 1.1em; font-weight: 600; color: var(--accent); margin: 0; }

        /* Tab panels */
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        @media (max-width: 900px) {
            .osm-map { height: 220px; }
        }
        @media (max-width: 600px) {
            .intro { flex-direction: column; align-items: flex-start; }
            .intro figure { margin-bottom: 1rem; }
            main { margin: 1rem 0; }
            .tabs { justify-content: space-between; }
        }

        /* Floating contact icons (bottom-right) */
        .contact-fab {
            position: fixed;
            right: 1rem;
            bottom: 1rem;
            display: flex;
            gap: 0.5rem;
            z-index: 9999;
            align-items: center;
        }
        .contact-fab a {
            width: 46px;
            height: 46px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            text-decoration: none;
            color: inherit;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            transition: transform 120ms ease, box-shadow 120ms ease;
        }
        .contact-fab a:hover, .contact-fab a:focus {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.12);
            outline: none;
        }
        .contact-fab svg { width: 20px; height: 20px; display: block; fill: var(--accent); }
    </style>
</head>
<body>
    <header>
        <h1>Lars Grasmück</h1>
        <p>Willkommen auf meiner persönlichen Startseite.</p>
        <button id="theme-toggle" class="theme-toggle" aria-pressed="false" title="Toggle Dark Mode">Dark</button>
    </header>

    <main>
        <nav class="tabs" role="tablist" aria-label="Hauptnavigation">
            <button role="tab" aria-selected="true" aria-pressed="true" data-target="about">About me</button>
            <button role="tab" aria-selected="false" aria-pressed="false" data-target="stationen">Stationen</button>
            <button role="tab" aria-selected="false" aria-pressed="false" data-target="karten">Karten</button>
            <button role="tab" aria-selected="false" aria-pressed="false" data-target="3d-modell">3D-Modell</button>
            <button role="tab" aria-selected="false" aria-pressed="false" data-target="news">News</button>
        </nav>

        <section id="about" class="tab-panel active" role="tabpanel" aria-hidden="false">
            <h2>About me</h2>
            <div class="intro">
                <div class="intro-text">
                    <p>Herzlich Willkommen auf meiner Website!</p>
                    <p>Mein Name ist Lars Grasmück, ich absolviere ein duales Studium Geoinformatik und Vermessung in Frankfurt und Mainz.</p>
                </div>
                <figure>
                    <img src="assets/matterhorn.jpg" alt="Matterhorn" style="width: 100%; height: auto; border-radius: 8px; border: 3px solid var(--accent);">
                </figure>
            </div>
        </section>

        <section id="stationen" class="tab-panel" role="tabpanel" aria-hidden="true">
            <h2>Stationen</h2>
            <table>
                <thead>
                    <tr>
                        <th>Jahr</th>
                        <th>Station</th>
                        <th>Ort</th>
                        <th>Stichwort</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>2014–2023</td><td>Schule</td><td>Hanau</td><td>Abschluss</td></tr>
                    <tr><td>2023–heute</td><td>Studium Geoinformatik und Vermessung</td><td>Mainz</td><td>Studium</td></tr>
                    <tr><td>2023–heute</td><td>Duales Studium</td><td>Frankfurt</td><td>DB</td></tr>
                </tbody>
            </table>
        </section>

        <section id="karten" class="tab-panel" role="tabpanel" aria-hidden="true">
            <h2>Meine Karten</h2>
            <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                <div id="map1" class="osm-map" style="flex: 1 1 calc(50% - 0.5rem); min-width: 220px; max-width: 100%;"></div>
                <div id="map2" class="osm-map" style="flex: 1 1 calc(50% - 0.5rem); min-width: 220px; max-width: 100%;"></div>
                <div id="map3" class="osm-map" style="flex: 1 1 calc(50% - 0.5rem); min-width: 220px; max-width: 100%;"></div>
                <div id="map4" class="osm-map" style="flex: 1 1 calc(50% - 0.5rem); min-width: 220px; max-width: 100%;"></div>
            </div>
        </section>

        <section id="3d-modell" class="tab-panel" role="tabpanel" aria-hidden="true">
            <h2>3D-Modell (LoD2 Gebäude)</h2>
            <!-- Embed the Cesium page in an iframe so it runs isolated from the main page's Leaflet logic -->
            <iframe src="map_5_cesium.html" title="3D-Modell Viewer" style="width:100%; min-height:560px; height:70vh; border:0; border-radius:8px;" loading="lazy"></iframe>
        </section>

        <section id="news" class="tab-panel" role="tabpanel" aria-hidden="true">
            <h2>News</h2>
            <div id="news-gallery" class="gallery" aria-live="polite">
                <!-- News items will be loaded here from assets/news.json -->
            </div>
        </section>
    </main>

    <!-- floating contact links -->
    <div class="contact-fab" aria-hidden="false">
        <a href="https://en.wikipedia.org/wiki/Ada_Lovelace" target="_blank" rel="noopener noreferrer" aria-label="Wikipedia — Ada Lovelace">
            <!-- simple LinkedIn-like icon -->
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><rect x="2" y="2" width="20" height="20" rx="3" ry="3" fill="none" stroke="currentColor" stroke-width="1.2"/><path d="M6.5 9.5h2.5v8H6.5zM8.75 6.5a1.25 1.25 0 1 1 0 2.5 1.25 1.25 0 0 1 0-2.5zM12 9.5h2.2v1.05h.03c.31-.58 1.07-1.2 2.2-1.2 2.35 0 2.78 1.55 2.78 3.57V17.5h-2.5v-3.1c0-.74-.01-1.7-1.04-1.7-1.04 0-1.2.81-1.2 1.64V17.5H12z"/></svg>
        </a>

        <a href="https://commons.wikimedia.org/wiki/Category:Ada_Lovelace" target="_blank" rel="noopener noreferrer" aria-label="Wikimedia Commons — Ada Lovelace">
            <!-- simple GitHub-like icon -->
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M12 .5C5.73.5.5 5.73.5 12c0 5.08 3.29 9.39 7.86 10.91.58.11.79-.25.79-.56v-2.02c-3.2.7-3.87-1.37-3.87-1.37-.53-1.35-1.3-1.71-1.3-1.71-1.06-.72.08-.71.08-.71 1.17.08 1.78 1.2 1.78 1.2 1.04 1.78 2.73 1.27 3.4.97.11-.76.41-1.27.74-1.56-2.55-.29-5.24-1.28-5.24-5.7 0-1.26.45-2.3 1.2-3.11-.12-.29-.52-1.46.11-3.05 0 0 .98-.31 3.2 1.19.93-.26 1.92-.39 2.9-.39.98 0 1.97.13 2.9.39 2.22-1.5 3.2-1.19 3.2-1.19.63 1.59.23 2.76.11 3.05.75.81 1.2 1.85 1.2 3.11 0 4.43-2.7 5.4-5.27 5.68.42.36.8 1.07.8 2.16v3.2c0 .31.21.68.8.56C20.71 21.39 24 17.08 24 12 24 5.73 18.27.5 12 .5z"/></svg>
        </a>

        <a href="https://www.britannica.com/biography/Ada-Lovelace" target="_blank" rel="noopener noreferrer" aria-label="Britannica — Ada Lovelace">
            <!-- simple mail icon -->
            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M2 6.5C2 5.12 3.12 4 4.5 4h15c1.38 0 2.5 1.12 2.5 2.5v11c0 1.38-1.12 2.5-2.5 2.5h-15C3.12 20 2 18.88 2 17.5v-11zM4.5 6l7.5 5 7.5-5v-.5L12 11 4.5 5.5V6z"/></svg>
        </a>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        // Theme toggle with persistence and theme change event
        (function() {
            var btn = document.getElementById('theme-toggle');
            var stored = localStorage.getItem('theme'); // 'dark' or 'light'

            function applyTheme(theme) {
                if (theme === 'dark') {
                    document.body.classList.add('dark');
                    btn.setAttribute('aria-pressed', 'true');
                    btn.textContent = 'Light';
                } else {
                    document.body.classList.remove('dark');
                    btn.setAttribute('aria-pressed', 'false');
                    btn.textContent = 'Dark';
                }
                // notify other parts (maps) about theme change
                window.dispatchEvent(new CustomEvent('themeChange', { detail: theme }));
            }

            // Initial theme: stored > prefers-color-scheme > light
            if (stored) {
                applyTheme(stored);
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                applyTheme('dark');
            } else {
                applyTheme('light');
            }

            btn.addEventListener('click', function () {
                var isDark = document.body.classList.toggle('dark');
                var theme = isDark ? 'dark' : 'light';
                localStorage.setItem('theme', theme);
                applyTheme(theme);
            });
        })();

        // Tab behavior and map initialization with map dark/light tile switching
        (function() {
            var tabs = document.querySelectorAll('.tabs button');
            var panels = document.querySelectorAll('.tab-panel');
            var maps = null;
            var tileLayers = [];
            var mapsCreated = false;

            var lightTiles = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
            var lightAttribution = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';
            var darkTiles = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png';
            var darkAttribution = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors & <a href="https://carto.com/attributions">CartoDB</a>';

            function setActiveTab(targetId) {
                tabs.forEach(function(t) {
                    var is = t.dataset.target === targetId;
                    t.setAttribute('aria-selected', is ? 'true' : 'false');
                    t.setAttribute('aria-pressed', is ? 'true' : 'false');
                });
                panels.forEach(function(p) {
                    var is = p.id === targetId;
                    p.classList.toggle('active', is);
                    p.setAttribute('aria-hidden', is ? 'false' : 'true');
                });

                if (targetId === 'karten') {
                    showMaps();
                }

                if (targetId === 'news') {
                    // lazy load news when the tab is first opened
                    if (!window._newsLoaded) {
                        loadNews();
                        window._newsLoaded = true;
                    }
                }
            }

            tabs.forEach(function(btn) {
                btn.addEventListener('click', function() {
                    setActiveTab(btn.dataset.target);
                });
            });

            // Map creation on demand (to avoid leaflet issues when hidden)
            function showMaps() {
                if (!mapsCreated) {
                    createMaps();
                    mapsCreated = true;
                } else {
                    // If already created, notify Leaflet to recalc sizes
                    setTimeout(function() {
                        maps.forEach(function(m) { m.invalidateSize(); });
                    }, 50);
                }
            }

            function createMaps() {
                var flexContainer = document.getElementById('map1').parentElement;
                while (flexContainer.firstChild) flexContainer.removeChild(flexContainer.firstChild);

                ['map_1.html', 'map_2.html', 'map_3.html', 'map_4.html'].forEach(function(src, idx) {
                    var f = document.createElement('iframe');
                    f.src = src;
                    f.setAttribute('aria-label', 'Karte ' + (idx + 1));
                    f.style.flex = '1 1 calc(50% - 0.5rem)';
                    f.style.width = 'calc(50% - 0.5rem)';
                    f.style.boxSizing = 'border-box';
                    f.style.minHeight = '420px';
                    f.style.height = '100%';
                    f.style.border = '0';
                    f.loading = 'lazy';
                    flexContainer.appendChild(f);
                });
            }

            // Replace tile layers when theme changes
            function updateMapTiles(theme) {
                if (!mapsCreated || !maps) return;
                var url = (theme === 'dark') ? darkTiles : lightTiles;
                var attr = (theme === 'dark') ? darkAttribution : lightAttribution;
                maps.forEach(function(map, idx) {
                    // remove previous tile layer if present
                    if (tileLayers[idx]) {
                        try { map.removeLayer(tileLayers[idx]); } catch (e) { /* ignore */ }
                    }
                    var newLayer = L.tileLayer(url, { attribution: attr });
                    newLayer.addTo(map);
                    tileLayers[idx] = newLayer;
                });
                // give Leaflet a moment to re-render
                setTimeout(function() {
                    maps.forEach(function(m) { m.invalidateSize(); });
                }, 80);
            }

            // Listen for theme changes
            window.addEventListener('themeChange', function(e) {
                updateMapTiles(e.detail);
            });

            // Ensure initial state (default tab is the first)
            var initial = document.querySelector('.tabs button[aria-selected="true"]') || tabs[0];
            if (initial) setActiveTab(initial.dataset.target);

            // Game tab removed — no game initialization here

            // --- News loader -------------------------------------------------
            function createNewsCard(item) {
                var article = document.createElement('article');
                article.className = 'card';

                var img = document.createElement('img');
                img.src = item.image || '';
                img.alt = item.title || 'News Bild';
                article.appendChild(img);

                var content = document.createElement('div');
                content.className = 'card-content';

                var h3 = document.createElement('h3');
                h3.className = 'card-title';
                h3.textContent = item.title || '';

                var p = document.createElement('p');
                p.textContent = item.summary || '';

                var small = document.createElement('small');
                small.style.color = getComputedStyle(document.documentElement).getPropertyValue('--muted') || 'gray';
                small.textContent = formatDate(item.date || '');

                content.appendChild(h3);
                content.appendChild(p);
                content.appendChild(small);
                article.appendChild(content);

                // optional link wrapper
                if (item.link) {
                    var a = document.createElement('a');
                    a.href = item.link;
                    a.className = 'card-link';
                    a.style.textDecoration = 'none';
                    a.style.color = 'inherit';
                    a.setAttribute('aria-label', item.title || 'News');

                    // move article into link
                    a.appendChild(article.cloneNode(true));
                    return a;
                }

                return article;
            }

            function formatDate(d) {
                if (!d) return '';
                // try ISO YYYY-MM-DD
                var iso = d.match(/^\d{4}-\d{2}-\d{2}$/);
                if (iso) {
                    var dt = new Date(d + 'T00:00:00');
                    return dt.toLocaleDateString(undefined, { day: '2-digit', month: '2-digit', year: 'numeric' });
                }
                return d;
            }

            function loadNews() {
                var container = document.getElementById('news-gallery');
                if (!container) return;
                // show a simple loading state
                container.innerHTML = '<p>Lade News…</p>';

                // If page is opened via file:// the browser will block fetch requests to local files.
                if (window.location.protocol === 'file:') {
                    container.innerHTML = '<p>Die News können lokal (file://) nicht geladen werden. Bitte starte einen lokalen Webserver oder öffne die Seite über http(s).</p>';
                    return;
                }

                // Try a few possible relative URLs in case the page is served from a subpath.
                var candidates = [
                    'assets/news.json',
                    './assets/news.json',
                    window.location.pathname.replace(/\/[^\/]*$/, '') + '/assets/news.json',
                    window.location.origin + '/assets/news.json'
                ].filter(Boolean);

                var tried = 0;
                function tryFetch(urlIndex) {
                    if (urlIndex >= candidates.length) {
                        container.innerHTML = '<p>Fehler beim Laden der News.</p>';
                        return;
                    }
                    var url = candidates[urlIndex];
                    // attempt fetch without cache
                    fetch(url, { cache: 'no-store' }).then(function(resp) {
                        if (!resp.ok) throw new Error('HTTP ' + resp.status + ' for ' + url);
                        return resp.json();
                    }).then(function(data) {
                        var items = data && data.news ? data.news : [];
                        container.innerHTML = '';
                        if (!items.length) {
                            container.innerHTML = '<p>Keine News vorhanden.</p>';
                            return;
                        }
                        items.forEach(function(it) {
                            var node = createNewsCard(it);
                            container.appendChild(node);
                        });
                    }).catch(function(err) {
                        // try next candidate
                        // eslint-disable-next-line no-console
                        console.warn('news load failed for', url, err);
                        tryFetch(urlIndex + 1);
                    });
                }

                tryFetch(0);
            }

        })();
    </script>
</body>
</html>